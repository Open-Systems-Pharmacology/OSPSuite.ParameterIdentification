<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ospsuite.parameteridentification">
<title>User guide • ospsuite.parameteridentification</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="User guide">
<meta property="og:description" content="ospsuite.parameteridentification">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ospsuite.parameteridentification</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.3.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Parameter identification workflow</h6>
    <a class="dropdown-item" href="../articles/user-guide.html">User guide</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Details</h6>
    <a class="dropdown-item" href="../articles/error-calculation.html">Error calculation</a>
    <a class="dropdown-item" href="../articles/optimization-algorithms.html">Optimization algorithms</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/open-systems-pharmacology/ospsuite.parameteridentification/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>User guide</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/open-systems-pharmacology/ospsuite.parameteridentification/blob/HEAD/vignettes/user-guide.Rmd" class="external-link"><code>vignettes/user-guide.Rmd</code></a></small>
      <div class="d-none name"><code>user-guide.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="parameter-estimation-problems">Parameter estimation problems<a class="anchor" aria-label="anchor" href="#parameter-estimation-problems"></a>
</h3>
<p>Biosimulation models include numerical parameters that determine the
outputs of the model. Often, the values of these parameters are not
known in advance and have to be identified by matching possible model
outputs to the observed data. Finding parameter values that best match
the observed data is called <em>parameter identification</em>.</p>
<p>The <a href="https://github.com/open-systems-pharmacology/ospsuite.parameteridentification" class="external-link">ospsuite.parameteridentification</a> package provides
a workflow for setting up such tasks based on existing PKML models,
mapping model outputs to observed data, and estimating parameters.
Below, three models of increasing complexity are used to demonstrate the
functionality of the package.</p>
</div>
<div class="section level3">
<h3 id="pi-workflow">PI workflow<a class="anchor" aria-label="anchor" href="#pi-workflow"></a>
</h3>
<p>The overall workflow is similar to running parameter identification
(PI) in PK-Sim or MoBi, see the corresponding <a href="https://docs.open-systems-pharmacology.org/shared-tools-and-example-workflows/parameter-identification" class="external-link">documentation
chapter</a>.</p>
<p>To set up a PI task, the user has to define:</p>
<ul>
<li>
<p>A set of simulations</p>
<ul>
<li>You can use multiple simulations in one optimization task. As an
example, you can identify a value of the same parameter (e.g., the
lipophilicity of the compound) using data for different dosings.</li>
</ul>
</li>
<li><p>Definition of parameters to be identified</p></li>
<li><p>Mapping of model outputs to observed data</p></li>
<li><p>Configuration of the optimization task, including selection of
algorithm and algorithm options.</p></li>
</ul>
<div class="section level4">
<h4 id="simulations">Simulations<a class="anchor" aria-label="anchor" href="#simulations"></a>
</h4>
<p>A set of <code>Simulation</code> objects. See the documentation of
<code>{ospsuite-r}</code> on <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/articles/load-get.html" class="external-link">how
to load and adjust simulations</a>.</p>
<p>For this example, we will load two instances of the Aciclovir PBPK
model provided with the <code>{ospsuite-r}</code> package. We want to
optimize the lipophilicity and the renal clearance using plasma
concentration data gathered after a 10-minute intravenous infusion of
aciclovir at doses 250 mg and 500 mg. Lipophilicity will be considered a
scenario-independent parameter, i.e., the same value will be applied for
both simulations. For the renal clearance, we can assume an
inter-individual variability and will optimize the value of this
parameter separately for each dose group.</p>
<p>We will start by loading the simulation of the *.pkml file twice. The
dose in this simulation is set to 250 mg. Remember that both
<code>Simulation</code> objects are created by loading the same *.pkml
file, they represent two independent instances of a simulation.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_250mg</span> <span class="op">&lt;-</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Aciclovir.pkml"</span>, package <span class="op">=</span> <span class="st">"ospsuite"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sim_500mg</span> <span class="op">&lt;-</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Aciclovir.pkml"</span>, package <span class="op">=</span> <span class="st">"ospsuite"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In the next step, we will retrieve the objects of the application
dose parameters and change the dose of the second simulation to 500
mg.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Path to the dose parameter</span></span>
<span><span class="va">doseParameterPath</span> <span class="op">&lt;-</span> <span class="st">"Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|Dose"</span></span>
<span><span class="co"># Get the parameter from the first simulation</span></span>
<span></span>
<span><span class="co"># Get the instances of the parameters</span></span>
<span><span class="va">sim_250mg_doseParam</span> <span class="op">&lt;-</span> <span class="fu">getParameter</span><span class="op">(</span>path <span class="op">=</span> <span class="va">doseParameterPath</span>, container <span class="op">=</span> <span class="va">sim_250mg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sim_250mg_doseParam</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|Dose </span></span>
<span><span class="co">#&gt;    Value: 2.50e-04 [kg] </span></span>
<span><span class="co">#&gt;    isConstant: TRUE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE</span></span>
<span><span class="va">sim_500mg_doseParam</span> <span class="op">&lt;-</span> <span class="fu">getParameter</span><span class="op">(</span>path <span class="op">=</span> <span class="va">doseParameterPath</span>, container <span class="op">=</span> <span class="va">sim_500mg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Chage the value to 500 mg</span></span>
<span><span class="fu">setParameterValues</span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">sim_500mg_doseParam</span>, values <span class="op">=</span> <span class="fl">500</span>, units <span class="op">=</span> <span class="st">"mg"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sim_500mg_doseParam</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|Dose </span></span>
<span><span class="co">#&gt;    Value: 5.00e-04 [kg] </span></span>
<span><span class="co">#&gt;    isConstant: TRUE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="definition-of-parameters-to-be-identified">Definition of parameters to be identified<a class="anchor" aria-label="anchor" href="#definition-of-parameters-to-be-identified"></a>
</h4>
<p>Specification of parameters to be identified is done by creating
objects of the class <code>PIParameters</code>. A
<code>PIParameter</code> describes a single model parameter or a group
of parameters that will be optimized together, i.e., all model
parameters grouped to a <code>PIParameters</code> object will have the
same value during the optimization. A <code>PIParameter</code> also
defines the optimization’s start and the minimal and maximal values.</p>
<p>If multiple model parameters are linked in one
<code>PIParameters</code> instance, they can belong to different
simulations or come from the same simulation. If you have, for example,
two simulations for two individuals with the same compound, you may have
one identification parameter, lipophilicity, which is linked to both
lipophilicity parameters in the two simulations. At the same time, you
can define two identification parameters for the individual reference
concentrations of a specific enzyme.</p>
<p>Consider the example above. We will create three
<code>PIParameters</code> objects - one for the lipophilicity of
aciclovir, where the parameters from the two simulations are linked
together, and two <code>PIParameters</code> for the renal clearance, as
they are considered independent.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Creating a PIParameters object with two simulation parameters retrieved from different simulations</span></span>
<span><span class="va">piParameterLipo</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIParameters.html">PIParameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">getParameter</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Aciclovir|Lipophilicity"</span>, container <span class="op">=</span> <span class="va">sim_250mg</span><span class="op">)</span>,</span>
<span>  <span class="fu">getParameter</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Aciclovir|Lipophilicity"</span>, container <span class="op">=</span> <span class="va">sim_500mg</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Creating two separate PIParameters for the renal clearance</span></span>
<span><span class="va">piParameterCl_250mg</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIParameters.html">PIParameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>parameters <span class="op">=</span> <span class="fu">getParameter</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Neighborhoods|Kidney_pls_Kidney_ur|Aciclovir|Renal Clearances-TS|TSspec"</span>, container <span class="op">=</span> <span class="va">sim_250mg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">piParameterCl_500mg</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIParameters.html">PIParameters</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>parameters <span class="op">=</span> <span class="fu">getParameter</span><span class="op">(</span>path <span class="op">=</span> <span class="st">"Neighborhoods|Kidney_pls_Kidney_ur|Aciclovir|Renal Clearances-TS|TSspec"</span>, container <span class="op">=</span> <span class="va">sim_500mg</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Each <code>PIParameter</code> has the following properties:</p>
<ul>
<li><p><code>$value</code>: Current value of the parameter. Corresponds
to the value of the <code>Parameter</code> object used in the
<code>PIParameters</code>. If multiple parameters are linked together,
the value of the first parameter added is used.</p></li>
<li><p><code>$startValue</code>: Start value of the parameter(s) used in
the identification. By default, the value of the first added parameter.
Can be changed.</p></li>
<li><p><code>$minValue</code>: Minimal allowed value. By default,
0.1-fold of the start value. Can be changed.</p></li>
<li><p><code>$maxValue</code>: Maximal allowed value. By default,
10-fold of the start value. Can be changed.</p></li>
<li><p><code>$unit</code>: Unit of the start, min, and max values.
WARNING: changing the unit does not update the values! E.g., the default
start, min, and max values of the renal clearance parameter are given in
<code>1/min</code>:</p></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">piParameterCl_250mg</span><span class="op">)</span></span>
<span><span class="co">#&gt; PIParameters: </span></span>
<span><span class="co">#&gt;    Number of parameters: 1 </span></span>
<span><span class="co">#&gt;    Value: 0.941241 </span></span>
<span><span class="co">#&gt;    Start value: 0.941241 </span></span>
<span><span class="co">#&gt;    Min value: 0.0941241 </span></span>
<span><span class="co">#&gt;    Max value: 9.41241 </span></span>
<span><span class="co">#&gt;    Unit: 1/min</span></span></code></pre></div>
<p>Setting the unit to <code>1/h</code> will cause the identification to
start at <code>0.94 1/h</code>, while the current value is still
<code>0.94 1/h</code> or <code>0.94 1/h * 60 min = 56.47 1/h</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piParameterCl_250mg</span><span class="op">$</span><span class="va">unit</span> <span class="op">&lt;-</span> <span class="va">ospUnits</span><span class="op">$</span><span class="va">`Inversed time`</span><span class="op">$</span><span class="va">`1/h`</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">piParameterCl_250mg</span><span class="op">)</span></span>
<span><span class="co">#&gt; PIParameters: </span></span>
<span><span class="co">#&gt;    Number of parameters: 1 </span></span>
<span><span class="co">#&gt;    Value: 56.47446 </span></span>
<span><span class="co">#&gt;    Start value: 0.941241 </span></span>
<span><span class="co">#&gt;    Min value: 0.0941241 </span></span>
<span><span class="co">#&gt;    Max value: 9.41241 </span></span>
<span><span class="co">#&gt;    Unit: 1/h</span></span></code></pre></div>
<p>We will set the boundaries for lipophilicity to [-10, 10], and for
renal clearance to [0, 10] <code>1/min</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piParameterLipo</span><span class="op">$</span><span class="va">minValue</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">10</span></span>
<span><span class="va">piParameterLipo</span><span class="op">$</span><span class="va">maxValue</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="va">piParameterCl_250mg</span><span class="op">$</span><span class="va">minValue</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">piParameterCl_250mg</span><span class="op">$</span><span class="va">maxValue</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">piParameterCl_250mg</span><span class="op">$</span><span class="va">unit</span> <span class="op">&lt;-</span> <span class="va">ospUnits</span><span class="op">$</span><span class="va">`Inversed time`</span><span class="op">$</span><span class="va">`1/min`</span></span>
<span></span>
<span><span class="va">piParameterCl_500mg</span><span class="op">$</span><span class="va">minValue</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">piParameterCl_500mg</span><span class="op">$</span><span class="va">maxValue</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">piParameterCl_500mg</span><span class="op">$</span><span class="va">unit</span> <span class="op">&lt;-</span> <span class="va">ospUnits</span><span class="op">$</span><span class="va">`Inversed time`</span><span class="op">$</span><span class="va">`1/min`</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">piParameterLipo</span><span class="op">)</span></span>
<span><span class="co">#&gt; PIParameters: </span></span>
<span><span class="co">#&gt;    Number of parameters: 2 </span></span>
<span><span class="co">#&gt;    Value: -0.097 </span></span>
<span><span class="co">#&gt;    Start value: -0.097 </span></span>
<span><span class="co">#&gt;    Min value: -10 </span></span>
<span><span class="co">#&gt;    Max value: 10 </span></span>
<span><span class="co">#&gt;    Unit: Log Units</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">piParameterCl_250mg</span><span class="op">)</span></span>
<span><span class="co">#&gt; PIParameters: </span></span>
<span><span class="co">#&gt;    Number of parameters: 1 </span></span>
<span><span class="co">#&gt;    Value: 0.941241 </span></span>
<span><span class="co">#&gt;    Start value: 0.941241 </span></span>
<span><span class="co">#&gt;    Min value: 0 </span></span>
<span><span class="co">#&gt;    Max value: 10 </span></span>
<span><span class="co">#&gt;    Unit: 1/min</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">piParameterCl_500mg</span><span class="op">)</span></span>
<span><span class="co">#&gt; PIParameters: </span></span>
<span><span class="co">#&gt;    Number of parameters: 1 </span></span>
<span><span class="co">#&gt;    Value: 0.941241 </span></span>
<span><span class="co">#&gt;    Start value: 0.941241 </span></span>
<span><span class="co">#&gt;    Min value: 0 </span></span>
<span><span class="co">#&gt;    Max value: 10 </span></span>
<span><span class="co">#&gt;    Unit: 1/min</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="mapping-of-model-output-to-observed-data">Mapping of model output to observed data<a class="anchor" aria-label="anchor" href="#mapping-of-model-output-to-observed-data"></a>
</h4>
<p>In order to calculate the error of the model, simulation outputs must
be linked to observed data. One simulation output can be linked to
multiple observed data sets in this framework. The error will be
calculated for each pair of simulated output and linked data set and
added up for the total error. The mapping is done by creating an object
of the class <code>PIOutputMapping</code>. Each object links a single <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/Quantity.html" class="external-link"><code>Quantity</code></a>
of a simulation to multiple <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/DataSet.html" class="external-link"><code>DataSet</code></a>
objects.</p>
<p>In the first step, we will load two observed data sets from the Excel
file provided with the package. Read the article <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/articles/observed-data.html" class="external-link">Observed
data</a> from the <a href="https://github.com/open-systems-pharmacology/ospsuite-r" class="external-link">ospsuite</a> documentation for details.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filePath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Aciclovir_Profiles.xlsx"</span>, package <span class="op">=</span> <span class="st">"ospsuite.parameteridentification"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create importer configuration for the file</span></span>
<span><span class="va">importConfig</span> <span class="op">&lt;-</span> <span class="fu">createImporterConfigurationForFile</span><span class="op">(</span>filePath <span class="op">=</span> <span class="va">filePath</span><span class="op">)</span></span>
<span><span class="co"># Set naming patter</span></span>
<span><span class="va">importConfig</span><span class="op">$</span><span class="va">namingPattern</span> <span class="op">&lt;-</span> <span class="st">"{Source}.{Sheet}.{Dose}"</span></span>
<span><span class="co"># Import data sets</span></span>
<span><span class="va">obsData</span> <span class="op">&lt;-</span> <span class="fu">loadDataSetsFromExcel</span><span class="op">(</span>xlsFilePath <span class="op">=</span> <span class="va">filePath</span>, importerConfigurationOrPath <span class="op">=</span> <span class="va">importConfig</span>, importAllSheets <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">obsData</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Aciclovir_Profiles.Vergin 1995.Iv.250 mg"</span></span>
<span><span class="co">#&gt; [2] "Aciclovir_Profiles.Vergin 1995.Iv.500 mg"</span></span></code></pre></div>
<p>The data sets hold concentration data of aciclovir in venous blood;
the corresponding simulation output has the path:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simOutputPath</span> <span class="op">&lt;-</span> <span class="st">"Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous Blood)"</span></span></code></pre></div>
<p>We will create two objects of the <code>PIOutputMapping</code> class,
one for each dose group:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outputMapping_250mg</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIOutputMapping.html">PIOutputMapping</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>quantity <span class="op">=</span> <span class="fu">getQuantity</span><span class="op">(</span>path <span class="op">=</span> <span class="va">simOutputPath</span>, container <span class="op">=</span> <span class="va">sim_250mg</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">outputMapping_500mg</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIOutputMapping.html">PIOutputMapping</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>quantity <span class="op">=</span> <span class="fu">getQuantity</span><span class="op">(</span>path <span class="op">=</span> <span class="va">simOutputPath</span>, container <span class="op">=</span> <span class="va">sim_500mg</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and link simulation results to the corresponding observed data:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outputMapping_250mg</span><span class="op">$</span><span class="fu">addObservedDataSets</span><span class="op">(</span><span class="va">obsData</span><span class="op">$</span><span class="va">`Aciclovir_Profiles.Vergin 1995.Iv.250 mg`</span><span class="op">)</span></span>
<span><span class="va">outputMapping_500mg</span><span class="op">$</span><span class="fu">addObservedDataSets</span><span class="op">(</span><span class="va">obsData</span><span class="op">$</span><span class="va">`Aciclovir_Profiles.Vergin 1995.Iv.500 mg`</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">outputMapping_250mg</span><span class="op">)</span></span>
<span><span class="co">#&gt; PIOutputMapping: </span></span>
<span><span class="co">#&gt;    Output path: Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous Blood) </span></span>
<span><span class="co">#&gt;    Observed data labels: Aciclovir_Profiles.Vergin 1995.Iv.250 mg </span></span>
<span><span class="co">#&gt;    Scaling: lin</span></span></code></pre></div>
<p>The scaling of the output mapping defines how the residuals between
simulated and observed data are calculated. For details, see the article
error-functions. For concentration data, we will change the scaling to
logarithmic:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outputMapping_250mg</span><span class="op">$</span><span class="va">scaling</span> <span class="op">&lt;-</span> <span class="st">"log"</span></span>
<span><span class="va">outputMapping_500mg</span><span class="op">$</span><span class="va">scaling</span> <span class="op">&lt;-</span> <span class="st">"log"</span></span></code></pre></div>
<p>All data sets (simulated results and observed data) within a
<code>PIOutputMapping</code> can be transformed by applying offsets and
scaling factors following the same logic implemented in the <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/articles/data-combined.html#transformations" class="external-link"><code>DataCombined</code>
class</a>.</p>
</div>
<div class="section level4">
<h4 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h4>
<p>The configuration of a PI includes the selection of an algorithm,
setting algorithm settings, and some further options. A PI configuration
is defined in a <code>PIConfiguration</code> object and can be re-used
by multiple PI tasks. If no user-defined configuration is provided to a
PI task, a default one is created with the following properties:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piConfiguration</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/PIConfiguration.html">PIConfiguration</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">piConfiguration</span><span class="op">)</span></span>
<span><span class="co">#&gt; PIConfiguration: </span></span>
<span><span class="co">#&gt;    Print feedback after each function evaluation: FALSE </span></span>
<span><span class="co">#&gt;    Objective function type: lsq </span></span>
<span><span class="co">#&gt;    Residual weighting method: none </span></span>
<span><span class="co">#&gt;    Robust residual calculation method: none </span></span>
<span><span class="co">#&gt;    Optimization algorithm: BOBYQA</span></span></code></pre></div>
<ul>
<li><p><code>printEvaluationFeedback</code> (logical) indicates if the
objective function value should be printed at each iteration</p></li>
<li><p><code>simulationRunOptions</code>: Object of type <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/SimulationRunOptions.html" class="external-link"><code>SimulationRunOptions</code></a>
that will be passed to simulation runs. If <code>NULL</code>, default
options are used.</p></li>
<li><p><code>targetFunctionType</code> (possible values are listed in
<code><a href="../reference/ObjectiveFunctionOptions.html">ospsuite.parameteridentification::ObjectiveFunctionOptions</a></code>)
indicates which objective function should be used to calculate the
difference between observed data and simulated curve. See the article
<code><a href="../articles/error-calculation.html">vignette("error-calculation")</a></code> for more
information.</p></li>
<li><p><code>algorithm</code> (possible values: HJKB, BOBYQA, DEoptim)
indicates which of the optimization algorithms should be used. Algorithm
options can be specified as a list and passed to
<code>piConfiguration$algorithmOptions</code>. Supported algorithms and
their options are described in
<code><a href="../articles/optimization-algorithms.html">vignette("optimization-algorithms")</a></code>.</p></li>
</ul>
<p>The default settings are listed in <code>AlgorithmOptions_XYZ</code>,
where <code>XYZ</code> is the algorithm’s name. For example, the default
settings for the <code>BOBYQA</code> algorithm are stored in
<code>AlgorithmOptions_BOBYQA</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">AlgorithmOptions_BOBYQA</span><span class="op">)</span></span>
<span><span class="co">#&gt; $stopval</span></span>
<span><span class="co">#&gt; [1] -Inf</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $xtol_rel</span></span>
<span><span class="co">#&gt; [1] 1e-06</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $maxeval</span></span>
<span><span class="co">#&gt; [1] 1000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ftol_rel</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ftol_abs</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $check_derivatives</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>E.g. to set the maximal number of function evaluations to 1500 for
the <code>BOBYQA</code> algorithm, we can use the following code:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">defOptions</span> <span class="op">&lt;-</span> <span class="va">AlgorithmOptions_BOBYQA</span></span>
<span><span class="va">defOptions</span><span class="op">$</span><span class="va">maxFunctionEvaluations</span> <span class="op">&lt;-</span> <span class="fl">1500</span></span>
<span><span class="va">piConfiguration</span><span class="op">$</span><span class="va">algorithmOptions</span> <span class="op">&lt;-</span> <span class="va">defOptions</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="running-a-parameter-identification-task">Running a parameter identification task<a class="anchor" aria-label="anchor" href="#running-a-parameter-identification-task"></a>
</h4>
<p>After the simulation, identification parameters, mappings of observed
and simulated data, and the configuration are defined, they are used in
an instance of the <code>ParameterIdentification</code> class:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piTask</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/ParameterIdentification.html">ParameterIdentification</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  simulations <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sim_250mg</span>, <span class="va">sim_500mg</span><span class="op">)</span>,</span>
<span>  parameters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">piParameterLipo</span>, <span class="va">piParameterCl_250mg</span>, <span class="va">piParameterCl_500mg</span><span class="op">)</span>,</span>
<span>  outputMappings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">outputMapping_250mg</span>, <span class="va">outputMapping_500mg</span><span class="op">)</span>,</span>
<span>  configuration <span class="op">=</span> <span class="va">piConfiguration</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We first can create time profiles comparing simulation results with
observed data with the current parameter values. A separate time profile
is created for each <code>PIOutputMapping</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piTask</span><span class="op">$</span><span class="fu">plotResults</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in ggplot2::scale_y_continuous(limits = private$.valuesLimits, position = self$position, : <span style="color: #00BB00;">log-10</span> transformation introduced infinite values.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">log-10</span> transformation introduced infinite values.</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; Warning in ggplot2::scale_y_continuous(limits = private$.valuesLimits, position</span></span>
<span><span class="co">#&gt; = self$position, : <span style="color: #00BB00;">log-10</span> transformation introduced infinite</span></span>
<span><span class="co">#&gt; values.</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; Warning in ggplot2::scale_y_continuous(limits = private$.valuesLimits, position</span></span>
<span><span class="co">#&gt; = self$position, : <span style="color: #00BB00;">log-10</span> transformation introduced infinite</span></span>
<span><span class="co">#&gt; values.</span></span></code></pre>
<p><img src="user-guide_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<p>NOTE: the figures are created with the current values of the
parameters, not the start values!</p>
<p>We can now run the PI and print the results:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piResults</span> <span class="op">&lt;-</span> <span class="va">piTask</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running optimization algorithm: BOBYQA</span></span>
<span><span class="co">#&gt; Warning in nl.opts(control): Unknown names in control: maxFunctionEvaluations</span></span>
<span><span class="co">#&gt; Post-hoc estimation of Hessian matrix.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">piResults</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -1.2816387  0.8352532  0.7571563</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 6.536445</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iter</span></span>
<span><span class="co">#&gt; [1] 109</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "NLOPT_SUCCESS: Generic success return value."</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $elapsed</span></span>
<span><span class="co">#&gt; [1] 32.86</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $algorithm</span></span>
<span><span class="co">#&gt; [1] "BOBYQA"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $nrOfFnEvaluations</span></span>
<span><span class="co">#&gt; [1] 111</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $hessian</span></span>
<span><span class="co">#&gt;           [,1]          [,2]          [,3]</span></span>
<span><span class="co">#&gt; [1,] 49.859194 -4.596684e+00 -5.102561e+00</span></span>
<span><span class="co">#&gt; [2,] -4.596684  2.127266e+01  1.193018e-11</span></span>
<span><span class="co">#&gt; [3,] -5.102561  1.193018e-11  2.534869e+01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $sigma</span></span>
<span><span class="co">#&gt; [1] 0.2044678 0.3097894 0.2838900</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $lwr</span></span>
<span><span class="co">#&gt; [1] -1.6823882  0.2280772  0.2007420</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $upr</span></span>
<span><span class="co">#&gt; [1] -0.8808893  1.4424293  1.3135706</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $cv</span></span>
<span><span class="co">#&gt; [1] 15.95362 37.08928 37.49425</span></span></code></pre></div>
<p>The output of the optimization run is:</p>
<ul>
<li>
<code>taskResults$par</code>: a vector of point estimates for each
of the parameters</li>
<li>
<code>taskResults$lwr</code> and <code>taskResults$upr</code>:
vectors with lower bounds and upper bounds for the 95% confidence
interval for each of the parameters</li>
<li>
<code>taskResults$cv</code>: a vector with the coefficient of
variation (standard deviation over point estimate, in percents) for each
of the parameters</li>
<li>
<code>taskResults$value</code> is the objective function value at
the point estimate</li>
<li>
<code>taskResults$elapsed</code> (seconds) is the wall time it took
to run the main optimization routine, excluding the hessian
calculations</li>
<li>
<code>taskResults$nrOfFnEvaluations</code> is the number of times
the objective function was evaluated in the main optimization routine,
excluding the hessian calculations</li>
</ul>
<p>The optimal values are directly applied to the <code>Parameter</code>
objects used in the PI.</p>
</div>
<div class="section level4">
<h4 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h4>
<p>To assess the goodness of the fit, plot the time profiles after the
optimization:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">piTask</span><span class="op">$</span><span class="fu">plotResults</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in ggplot2::scale_y_continuous(limits = private$.valuesLimits, position = self$position, : <span style="color: #00BB00;">log-10</span> transformation introduced infinite values.</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">log-10</span> transformation introduced infinite values.</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; Warning in ggplot2::scale_y_continuous(limits = private$.valuesLimits, position</span></span>
<span><span class="co">#&gt; = self$position, : <span style="color: #00BB00;">log-10</span> transformation introduced infinite</span></span>
<span><span class="co">#&gt; values.</span></span></code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<pre><code><span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; Warning in ggplot2::scale_y_continuous(limits = private$.valuesLimits, position</span></span>
<span><span class="co">#&gt; = self$position, : <span style="color: #00BB00;">log-10</span> transformation introduced infinite</span></span>
<span><span class="co">#&gt; values.</span></span></code></pre>
<p><img src="user-guide_files/figure-html/unnamed-chunk-15-2.png" width="700"></p>
<p>The quality of the fit can be assessed by the following criteria:</p>
<ul>
<li>The individual time profile is close to the observed data
points.</li>
<li>The predicted-vs-observed plot is close to the diagonal.</li>
<li>The residuals are randomly distributed above and below zero.</li>
</ul>
<p>The residuals only above or only below zero indicate an
overprediction or an underprediction. Another set of parameters will
likely result in a better fit.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://esqlabs.com/" class="external-link"><img src="https://esqlabs.github.io/esqlabsR/reference/figures/esqlabs.png" style="max-width:33px">esqLABS</a>, <a href="https://github.com/PavelBal" class="external-link">Pavel Balazki</a>, <a href="https://github.com/svavil" class="external-link">Sergei Vavilov</a>, <a href="https://github.com/rengelke" class="external-link">Rudi Engelke</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
